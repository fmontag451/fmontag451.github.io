<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>Documentation with Doxygen and CMake: a (slightly) improved approach &middot; Federico Ficarelli</title>

  
  <link rel="stylesheet" href="https://nazavode.github.io/css/poole.css">
  <link rel="stylesheet" href="https://nazavode.github.io/css/hyde.css">
  <link rel="stylesheet" href="https://nazavode.github.io/css/poole-overrides.css">
  <link rel="stylesheet" href="https://nazavode.github.io/css/hyde-overrides.css">
  <link rel="stylesheet" href="https://nazavode.github.io/css/hyde-x.css">
  
  <link href="https://fonts.googleapis.com/css?family=Fira+Mono|Fira+Sans:300,300i|Raleway" rel="stylesheet">
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
  

  
  
  
  

  <meta name="description" content="Generating Doxygen documentation with CMake with proper targets and dependency checking.">
  <meta name="keywords" content="hacking,development,software,python,c&#43;&#43;,c99,algorithms">
  

  
  <script src="//ajax.googleapis.com/ajax/libs/webfont/1.4.7/webfont.js"></script>
  <script>
    WebFont.load({
      google: {
        families: ['Raleway', 'Fira Sans', 'Fira Mono']
      }
    });
  </script>

</head>
<body class="theme-base-sulphur-00">
<div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      
      <h1>/dev/null</h1>
      
    </div>

    <ul class="sidebar-nav">
      <li class="sidebar-nav-item"><a href="https://nazavode.github.io/">Blog</a></li>
      
      <li class="sidebar-nav-item"><a href="https://nazavode.github.io/about/">About</a></li>
      
    </ul>

    <ul class="sidebar-nav">
      <li class="sidebar-nav-item">
      <a href="https://github.com/nazavode"><i class="fa fa-github-square fa-1x"></i></a>
      
      
      <a href="https://it.linkedin.com/in/fficarelli"><i class="fa fa-linkedin-square fa-1x"></i></a>
      
      
      <a href="https://twitter.com/fficarelli"><i class="fa fa-twitter-square fa-1x"></i></a>
      
      <a href="https://nazavode.github.io/index.xml" type="application/rss+xml"><i class="fa fa-rss-square fa-1x"></i></a>
      </li>
    </ul>

    

    <p class="footnote">
        Powered by <a href="http://gohugo.io">Hugo</a><br/>
        &copy; 2019 Federico Ficarelli
    </p>

  </div>
</div>


<div class="content container">
  <div class="post">
    <h1 class="post-title">Documentation with Doxygen and CMake: a (slightly) improved approach</h1>
    <span class="post-date">Jan 19, 2013 &middot; <a href="https://nazavode.github.io/blog/cmake-doxygen-improved/#disqus_thread">Comments</a>
    
    <br/>
    <a class="label" href="https://nazavode.github.io/categories/dev">Dev</a><a class="label" href="https://nazavode.github.io/categories/tools">Tools</a>
    </span>
    <p>After days of hard work we ended up with our lovely crafted code base, a
portable CMake build system and we are now facing the task to generate a proper
Doxygen documentation for our anxious customer. The solution, widely adopted,
seems to be the one and only that can be found while googling and, to me, looks
not so neat. So I tried to come up with a different approach.</p>

<p>Let&rsquo;s first have a look at the widespread solution:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cmake" data-lang="cmake"><span style="color:#aaa;font-style:italic">#-- Adds an Option to toggle the generation of the API documentation
</span><span style="color:#aaa;font-style:italic"></span><span style="color:#0aa">option</span>(<span style="color:#a50">BUILD_DOCUMENTATION</span> <span style="color:#a50">&#34;Use Doxygen to create the HTML based API documentation&#34;</span> <span style="color:#a50">OFF</span>)<span style="color:#f00;background-color:#faa">
</span><span style="color:#f00;background-color:#faa"></span><span style="color:#0aa">IF</span>(<span style="color:#a50">BUILD_DOCUMENTATION</span>)<span style="color:#f00;background-color:#faa">
</span><span style="color:#f00;background-color:#faa"></span>  <span style="color:#0aa">FIND_PACKAGE</span>(<span style="color:#a50">Doxygen</span>)<span style="color:#f00;background-color:#faa">
</span><span style="color:#f00;background-color:#faa"></span>  <span style="color:#0aa">IF</span>(<span style="color:#a50">NOT</span> <span style="color:#a50">DOXYGEN_FOUND</span>)<span style="color:#f00;background-color:#faa">
</span><span style="color:#f00;background-color:#faa"></span>    <span style="color:#0aa">message</span>(<span style="color:#a50">FATAL_ERROR</span> <span style="color:#a50">&#34;Doxygen is needed to build the documentation&#34;</span>)<span style="color:#f00;background-color:#faa">
</span><span style="color:#f00;background-color:#faa"></span>  <span style="color:#0aa">ENDIF</span>()<span style="color:#f00;background-color:#faa">
</span><span style="color:#f00;background-color:#faa"></span>  <span style="color:#aaa;font-style:italic">#-- Configure the Template Doxyfile for our specific project
</span><span style="color:#aaa;font-style:italic"></span>  <span style="color:#0aa">configure_file</span>(<span style="color:#a50">Doxyfile.in</span> ${<span style="color:#a00">PROJECT_BINARY_DIR</span>}<span style="color:#a50">/Doxyfile</span> <span style="color:#a50">@ONLY</span> <span style="color:#a50">IMMEDIATE</span>)<span style="color:#f00;background-color:#faa">
</span><span style="color:#f00;background-color:#faa"></span>  <span style="color:#aaa;font-style:italic">#-- Add a custom target to run Doxygen when ever the project is built
</span><span style="color:#aaa;font-style:italic"></span>  <span style="color:#0aa">add_custom_target</span> (<span style="color:#a50">Docs</span> <span style="color:#a50">ALL</span>
    <span style="color:#a50">COMMAND</span> ${<span style="color:#a00">DOXYGEN_EXECUTABLE</span>} ${<span style="color:#a00">PROJECT_BINARY_DIR</span>}<span style="color:#a50">/Doxyfile</span>
    <span style="color:#a50">SOURCES</span> ${<span style="color:#a00">PROJECT_BINARY_DIR</span>}<span style="color:#a50">/Doxyfile</span>)<span style="color:#f00;background-color:#faa">
</span><span style="color:#f00;background-color:#faa"></span>  <span style="color:#aaa;font-style:italic"># IF you do NOT want the documentation to be generated EVERY time you build the project
</span><span style="color:#aaa;font-style:italic"></span>  <span style="color:#aaa;font-style:italic"># then leave out the &#39;ALL&#39; keyword from the above command.
</span><span style="color:#aaa;font-style:italic"></span><span style="color:#0aa">ENDIF</span>()</code></pre></div>
<p>Well, even if the above solution works like a charm, it exposes a flaw that
makes its adoption very annoying: <strong>Doxygen will be triggered every time we run
make, even if nothing has changed</strong>. Oh, <em>every time</em> means exactly <em>every
time</em>: each make invocation (make, make install, etc&hellip;) will flood your shell
with the utterly verbose output from Doxygen even if that step is obviously
useless. Yes, we have added that <code>ALL</code> flag to <code>ADD_CUSTOM_TARGET</code> but this is
the only way to have our documentation generated along with the default targets
(otherwise our <code>BUILD_DOCUMENTATION</code> flag would be ignored except for an
explicit <code>make doc</code>). This behavior is correct and the point is well highlighted
in the CMake reference for
<a href="https://cmake.org/cmake/help/v2.8.10/cmake.html#command:add_custom_target"><code>ADD_CUSTOM_TARGET</code></a>:</p>

<blockquote>
<p>The target has no output file and is ALWAYS CONSIDERED OUT OF DATE even if the commands
try to create a file with the name of the target. Use ADD_CUSTOM_COMMAND to generate a
file with dependencies.</p>
</blockquote>

<p>So, it seems that we are using the wrong tool. <strong>How can we add a Doxygen target
with a real dependency checking?</strong> The neat trick lies in the combined use of
two different commands:</p>

<ol>
<li><code>ADD_CUSTOM_COMMAND</code> will take care of dependency checking, firing up Doxygen
if and only if something (which the documentation depends on) has really changed
since last build;</li>
<li><code>ADD_CUSTOM_TARGET</code> will allow us to have a convenient and
elegant make doc target, eventually added to default set. After a bit of
trial-and-error, I ended up with a bunch of lines of code that seems to work as
we wanted:</li>
</ol>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cmake" data-lang="cmake"><span style="color:#0aa">option</span>(<span style="color:#a50">BUILD_DOCUMENTATION</span>
    <span style="color:#a50">&#34;Create and install the HTML based API documentation (requires Doxygen)&#34;</span> <span style="color:#a50">OFF</span>)<span style="color:#f00;background-color:#faa">
</span><span style="color:#f00;background-color:#faa"></span><span style="color:#0aa">IF</span>(<span style="color:#a50">BUILD_DOCUMENTATION</span>)<span style="color:#f00;background-color:#faa">
</span><span style="color:#f00;background-color:#faa"></span>  <span style="color:#0aa">FIND_PACKAGE</span>(<span style="color:#a50">Doxygen</span>)<span style="color:#f00;background-color:#faa">
</span><span style="color:#f00;background-color:#faa"></span>  <span style="color:#0aa">IF</span>(<span style="color:#a50">NOT</span> <span style="color:#a50">DOXYGEN_FOUND</span>)<span style="color:#f00;background-color:#faa">
</span><span style="color:#f00;background-color:#faa"></span>    <span style="color:#0aa">MESSAGE</span>(<span style="color:#a50">FATAL_ERROR</span> <span style="color:#a50">&#34;Doxygen is needed to build the documentation.&#34;</span>)<span style="color:#f00;background-color:#faa">
</span><span style="color:#f00;background-color:#faa"></span>  <span style="color:#0aa">ENDIF</span>()<span style="color:#f00;background-color:#faa">
</span><span style="color:#f00;background-color:#faa">
</span><span style="color:#f00;background-color:#faa"></span>  <span style="color:#0aa">SET</span>( <span style="color:#a50">doxyfile_in</span>          ${<span style="color:#a00">CMAKE_CURRENT_SOURCE_DIR</span>}<span style="color:#a50">/Doxyfile.in</span>)<span style="color:#f00;background-color:#faa">
</span><span style="color:#f00;background-color:#faa"></span>  <span style="color:#0aa">SET</span>( <span style="color:#a50">doxyfile</span>             ${<span style="color:#a00">PROJECT_BINARY_DIR</span>}<span style="color:#a50">/Doxyfile</span>)<span style="color:#f00;background-color:#faa">
</span><span style="color:#f00;background-color:#faa"></span>  <span style="color:#0aa">SET</span>( <span style="color:#a50">doxy_html_index_file</span> ${<span style="color:#a00">CMAKE_CURRENT_BINARY_DIR</span>}<span style="color:#a50">/html/index.html</span>)<span style="color:#f00;background-color:#faa">
</span><span style="color:#f00;background-color:#faa"></span>  <span style="color:#0aa">SET</span>( <span style="color:#a50">doxy_output_root</span>     ${<span style="color:#a00">CMAKE_CURRENT_BINARY_DIR</span>}) <span style="color:#aaa;font-style:italic"># Pasted into Doxyfile.in
</span><span style="color:#aaa;font-style:italic"></span>  <span style="color:#0aa">SET</span>( <span style="color:#a50">doxy_input</span>           ${<span style="color:#a00">PROJECT_SOURCE_DIR</span>}<span style="color:#a50">/src</span>) <span style="color:#aaa;font-style:italic"># Pasted into Doxyfile.in
</span><span style="color:#aaa;font-style:italic"></span>  <span style="color:#0aa">SET</span>( <span style="color:#a50">doxy_extra_files</span>     ${<span style="color:#a00">CMAKE_CURRENT_SOURCE_DIR</span>}<span style="color:#a50">/mainpage.dox</span>) <span style="color:#aaa;font-style:italic"># Pasted into Doxyfile.in
</span><span style="color:#aaa;font-style:italic"></span><span style="color:#f00;background-color:#faa">
</span><span style="color:#f00;background-color:#faa"></span>  <span style="color:#0aa">CONFIGURE_FILE</span>( ${<span style="color:#a00">doxyfile_in</span>} ${<span style="color:#a00">doxyfile</span>} <span style="color:#a50">@ONLY</span> )<span style="color:#f00;background-color:#faa">
</span><span style="color:#f00;background-color:#faa">
</span><span style="color:#f00;background-color:#faa"></span>  <span style="color:#0aa">ADD_CUSTOM_COMMAND</span>(
    <span style="color:#a50">OUTPUT</span> ${<span style="color:#a00">doxy_html_index_file</span>}
    <span style="color:#a50">COMMAND</span> ${<span style="color:#a00">DOXYGEN_EXECUTABLE</span>} ${<span style="color:#a00">doxyfile</span>}
    <span style="color:#aaa;font-style:italic"># The following should be ${doxyfile} only but it
</span><span style="color:#aaa;font-style:italic"></span>    <span style="color:#aaa;font-style:italic"># will break the dependency.
</span><span style="color:#aaa;font-style:italic"></span>    <span style="color:#aaa;font-style:italic"># The optimal solution would be creating a
</span><span style="color:#aaa;font-style:italic"></span>    <span style="color:#aaa;font-style:italic"># custom_command for ${doxyfile} generation
</span><span style="color:#aaa;font-style:italic"></span>    <span style="color:#aaa;font-style:italic"># but I still have to figure out how...
</span><span style="color:#aaa;font-style:italic"></span>    <span style="color:#a50">MAIN_DEPENDENCY</span> ${<span style="color:#a00">doxyfile</span>} ${<span style="color:#a00">doxyfile_in</span>}
    <span style="color:#a50">DEPENDS</span> <span style="color:#a50">project_targets</span> ${<span style="color:#a00">doxy_extra_files</span>}
    <span style="color:#a50">COMMENT</span> <span style="color:#a50">&#34;Generating HTML documentation&#34;</span>
  )<span style="color:#f00;background-color:#faa">
</span><span style="color:#f00;background-color:#faa">
</span><span style="color:#f00;background-color:#faa"></span>  <span style="color:#0aa">ADD_CUSTOM_TARGET</span>( <span style="color:#a50">doc</span> <span style="color:#a50">ALL</span> <span style="color:#a50">DEPENDS</span> ${<span style="color:#a00">doxy_html_index_file</span>} )<span style="color:#f00;background-color:#faa">
</span><span style="color:#f00;background-color:#faa">
</span><span style="color:#f00;background-color:#faa"></span>  <span style="color:#0aa">INSTALL</span>( <span style="color:#a50">DIRECTORY</span> ${<span style="color:#a00">CMAKE_CURRENT_BINARY_DIR</span>}<span style="color:#a50">/html</span> <span style="color:#a50">DESTINATION</span> <span style="color:#a50">share/doc</span> )<span style="color:#f00;background-color:#faa">
</span><span style="color:#f00;background-color:#faa"></span><span style="color:#0aa">ENDIF</span>()</code></pre></div>
<p>The point is that we still have our <code>doc</code> custom target (added to default
targets) that is going to be fired every time but the actual build step is
protected by the custom command that will check for the right dependencies. Just
a couple of remarks:</p>

<ul>
<li>the <code>DEPENDS</code> option on the custom command must list all of the targets, files
and whatever your documentation depends on;</li>
<li>the <code>${doxyfile_in}</code> dependency is an overshoot but, as I say in the comment,
removing it will break the dependency checking. The ideal solution would be
specifying <code>${doxyfile}</code> only, letting it to trigger a lower-level custom
command intended to configure and generate <code>${doxyfile_in}</code>. I&rsquo;m still trying to
find an elegant solution to this little aesthetic flaw.</li>
</ul>

<hr />

<p>Resources:</p>

<ul>
<li><a href="http://www.cmake.org/cmake/help/v2.8.10/cmake.html">CMake Reference Manual</a></li>
<li><a href="http://www.bluequartz.net/projects/EIM_Segmentation/SoftwareDocumentation/html/usewithcmakeproject.html">Use Doxygen with a CMake Based Project</a></li>
</ul>
  </div>
  <div id="disqus_thread"></div>
</div>


<script type="text/javascript">
var disqus_shortname = "nazavodeio";
(function () {
    var s = document.createElement('script'); s.async = true;
    s.type = 'text/javascript';
    s.src = '//' + disqus_shortname + '.disqus.com/count.js';
    (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
}());
</script>



<script type="text/javascript">
    var disqus_shortname = "nazavodeio";
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


</body>
</html>

